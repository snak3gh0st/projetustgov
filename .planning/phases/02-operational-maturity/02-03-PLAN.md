---
phase: 02-operational-maturity
plan: "03"
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - "src/monitor/reconciliation.py"
  - "src/monitor/lineage.py"
  - "prisma/schema.prisma"
autonomous: true
must_haves:
  truths:
    - "Reconciliation compares source row counts with DB inserts"
    - "Data lineage tracks source file, timestamp, and pipeline version per record"
    - "Lineage queries can find all records from a specific source file"
  artifacts:
    - path: "src/monitor/reconciliation.py"
      provides: "reconcile_file() and run_reconciliation() functions"
    - path: "src/monitor/lineage.py"
      provides: "record_lineage() and query_lineage() functions"
    - path: "prisma/schema.prisma"
      provides: "DataLineage model with entity_type, entity_id, source_file, timestamp, pipeline_version"
    - exports:
        - "reconcile_file"
        - "run_reconciliation"
        - "record_lineage"
        - "query_lineage"
  key_links:
    - from: "src/monitor/reconciliation.py"
      to: "src/loader/database.py"
      via: "Session queries for count comparison"
    - from: "src/monitor/reconciliation.py"
      to: "src/config/loader.py"
      via: "get_config().reconciliation"
    - from: "src/monitor/lineage.py"
      to: "prisma/schema.prisma"
      via: "DataLineage model for persistence"
    - from: "src/monitor/lineage.py"
      to: "src/monitor/alerting.py"
      via: "Alert on reconciliation mismatch"
---

<objective>
Implement reconciliation checks and data lineage tracking for audit trail and zero data loss verification.

**Purpose:** Reconciliation verifies source vs DB counts. Lineage tracks where each record came from for compliance.

**Output:** Reconciliation module and lineage tracking with database model.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-operational-maturity/02-RESEARCH.md
@.planning/phases/02-operational-maturity/02-01-PLAN.md
@.planning/phases/02-operational-maturity/02-02-PLAN.md

# Phase 1 already has:
- src/loader/extraction_log.py - ExtractionLog model and get_last_extraction()
- PostgreSQL models in src/loader/db_models.py

# Phase 2 requires:
- MON-04: Reconciliation check (source row count vs DB inserts)
- MON-06: Data lineage (source file, timestamp, pipeline version)
</context>

<tasks>

<task type="auto">
  <name>Add DataLineage model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
    Add to prisma/schema.prisma:

    ```prisma
    model DataLineage {
      id                Int      @id @default(autoincrement())
      entity_type       String   // "proposta", "apoiador", "emenda", "programa"
      entity_id         String   // The ID from the source file
      source_file       String   // Original filename
      extraction_date   DateTime // When the extraction ran
      pipeline_version  String?  // Version of projetus package
      record_hash       String?  // SHA256 of record content
      created_at       DateTime @default(now())

      @@index([entity_type, entity_id])
      @@index([source_file])
    }
    ```

    Run `npx prisma generate` after adding.
  </action>
  <verify>`npx prisma generate && echo "Prisma generated DataLineage model"`</verify>
  <done>DataLineage model exists in Prisma schema</done>
</task>

<task type="auto">
  <name>Create reconciliation module</name>
  <files>src/monitor/reconciliation.py</files>
  <action>
    Create src/monitor/reconciliation.py with:

    1. reconcile_file(file_path: str, entity_type: str) -> ReconciliationResult:
       - Counts rows in source file using polars
       - Queries DB count for this entity from this source_file
       - Returns ReconciliationResult namedtuple with:
         - source_count: int
         - db_count: int
         - match: bool
         - discrepancy: int | None

    2. run_reconciliation(raw_data_dir: Path) -> list[ReconciliationResult]:
       - Finds all files in data/raw (or specified date)
       - Infers entity_type from filename
       - Runs reconcile_file for each
       - Returns list of results
       - Alerts via send_alert() if mismatch detected and config.alert_on_mismatch

    3. get_reconciliation_summary(results: list[ReconciliationResult]) -> str:
       - Formats human-readable summary
       - Shows pass/fail for each file
       - Shows total discrepancy count
    </action>
  <verify>`python -c "from src.monitor.reconciliation import reconcile_file, run_reconciliation; print('reconciliation module loads')"`</verify>
  <done>reconcile_file and run_reconciliation functions exist</done>
</task>

<task type="auto">
  <name>Create lineage tracking module</name>
  <files>src/monitor/lineage.py</files>
  <action>
    Create src/monitor/lineage.py with:

    1. get_pipeline_version() -> str:
       - Returns version from pyproject.toml or "dev"
       - Cached with @lru_cache

    2. record_lineage(records: list[dict], source_file: str, extraction_date: datetime):
       - For each record, extracts:
         - entity_type (from _entity_type field or filename)
         - entity_id (id or transfer_gov_id)
         - record_hash (SHA256 of sorted JSON)
       - Inserts all to DataLineage table via Prisma
       - Returns number of records recorded

    3. query_lineage(source_file: str) -> list[dict]:
       - Queries DataLineage by source_file
       - Returns list of {entity_type, entity_id, extraction_date, pipeline_version}

    4. query_lineage_by_entity(entity_type: str, entity_id: str) -> list[dict]:
       - Finds all extractions for a specific entity
       - Useful for audit trails

    Call record_lineage in loader/upsert.py after successful upsert.
  </action>
  <verify>`python -c "from src.monitor.lineage import record_lineage, query_lineage; print('lineage module loads')"`</verify>
  <done>record_lineage and query_lineage functions exist</done>
</task>

</tasks>

<verification>
- [ ] `npx prisma generate` succeeds with DataLineage model
- [ ] `python -c "from src.monitor.reconciliation import reconcile_file; print('Reconciliation ready')"`
- [ ] `python -c "from src.monitor.lineage import record_lineage; print('Lineage ready')"`
- [ ] DataLineage table can be created via Prisma migrate
</verification>

<success_criteria>
Reconciliation and lineage work:
- reconcile_file compares source file rows with DB inserts
- run_reconciliation processes all files and alerts on mismatches
- record_lineage stores source_file, timestamp, pipeline_version per record
- query_lineage can find all records from a specific source file
</success_criteria>

<output>
After completion, create `.planning/phases/02-operational-maturity/02-03-SUMMARY.md`
</output>
