---
phase: 02-operational-maturity
plan: "02"
type: execute
wave: 1
depends_on: ["02-01"]
files_modified:
  - "src/monitor/alerting.py"
  - "src/monitor/volume_alerts.py"
  - "src/monitor/scheduler_health.py"
autonomous: true
must_haves:
  truths:
    - "Telegram alerts sent on extraction completion"
    - "Email alerts sent as backup if Telegram fails"
    - "Volume anomaly alerts trigger when counts differ >10% from previous"
    - "Scheduler miss alerts trigger if extraction didn't run at expected time"
  artifacts:
    - path: "src/monitor/alerting.py"
      provides: "send_telegram_alert() and send_email_alert() functions"
    - path: "src/monitor/volume_alerts.py"
      provides: "check_volume_anomaly() function"
    - path: "src/monitor/scheduler_health.py"
      provides: "check_scheduler_health() function"
    - exports:
        - "send_telegram_alert"
        - "send_email_alert"
        - "check_volume_anomaly"
        - "check_scheduler_health"
  key_links:
    - from: "src/monitor/alerting.py"
      to: "src/config/loader.py"
      via: "get_config().alerting"
    - from: "src/monitor/volume_alerts.py"
      to: "src/loader/extraction_log.py"
      via: "get_last_extraction()"
    - from: "src/monitor/scheduler_health.py"
      to: "src/loader/extraction_log.py"
      via: "get_last_extraction()"
---

<objective>
Implement enhanced alerting system with Telegram and email notifications, plus volume anomaly and scheduler health checks.

**Purpose:** Multi-channel alerting ensures notifications always reach users. Proactive alerts detect issues early.

**Output:** Alerting module with Telegram, email, volume alerts, and scheduler health checks.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-operational-maturity/02-RESEARCH.md
@.planning/phases/02-operational-maturity/02-01-PLAN.md

# Phase 1 already has:
- src/monitor/logger.py - JSON logging
- TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID in .env

# Phase 2 requires:
- MON-03: Email alerts (backup if Telegram fails)
- MON-04: Volume anomaly alerts (>10% vs previous)
- MON-06: Scheduler miss alerts
</context>

<tasks>

<task type="auto">
  <name>Create send_telegram_alert function</name>
  <files>src/monitor/alerting.py</files>
  <action>
    Create src/monitor/alerting.py with:

    1. send_telegram_alert(subject: str, body: str, severity: str = "INFO"):
       - Uses TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID from config
       - Sends to Telegram API: https://api.telegram.org/bot{bot_token}/sendMessage
       - Handles HTTP errors gracefully (returns False on failure)
       - Severity prefixes: "[CRITICAL]", "[WARNING]", "[INFO]"

    2. send_email_alert(subject: str, body: str, severity: str = "INFO"):
       - Uses SMTP settings from config
       - Connects to smtp_host:smtp_port, starts TLS
       - Authenticates with EMAIL_USER/EMAIL_PASS
       - Sends from EMAIL_FROM to all EMAIL_TO addresses
       - Returns False if SMTP fails

    3. send_alert(subject: str, body: str, severity: str = "INFO"):
       - Tries Telegram first
       - If Telegram fails AND email.enabled is true, tries email
       - Logs which channel succeeded or if both failed

    Reference patterns from 02-RESEARCH.md section "Email Alerting Options".
  </action>
  <verify>`python -c "from src.monitor.alerting import send_telegram_alert, send_email_alert; print('alerting module loads')"`</verify>
  <done>send_telegram_alert, send_email_alert, send_alert functions exist and import</done>
</task>

<task type="auto">
  <name>Create volume anomaly detection</name>
  <files>src/monitor/volume_alerts.py</files>
  <action>
    Create src/monitor/volume_alerts.py with:

    1. check_volume_anomaly(current_counts: dict[str, int]) -> tuple[bool, str]:
       - Gets previous extraction from get_last_extraction()
       - Returns (True, "Normal message") if within tolerance
       - Returns (False, "Anomaly message") if >10% change
       - Handles first run (previous_count == 0)
       - Message format: "Volume anomaly: 25% change (150 â†’ 200 records)"

    2. get_volume_alert_message(current: dict, previous: dict | None, tolerance: int) -> str:
       - Formats human-readable message with counts per entity
       - Shows percentage change

    3. should_alert_volume(current: dict, previous: dict | None, tolerance_percent: int) -> bool:
       - Returns True if ANY entity exceeds tolerance
       - Returns False if no previous data (first run)

    Uses get_config().reconciliation.volume_tolerance_percent for tolerance.
  </action>
  <verify>`python -c "from src.monitor.volume_alerts import check_volume_anomaly; print('volume_alerts module loads')"`</verify>
  <done>check_volume_anomaly function exists and returns (bool, str) tuple</done>
</task>

<task type="auto">
  <name>Create scheduler health check</name>
  <files>src/monitor/scheduler_health.py</files>
  <action>
    Create src/monitor/scheduler_health.py with:

    1. check_scheduler_health(expected_hour: int = 9) -> tuple[bool, str]:
       - Gets last extraction timestamp from get_last_extraction()
       - Returns (True, "Healthy: Last ran at {timestamp}") if recent
       - Returns (False, "Scheduler miss: No extraction since {date}") if old
       - "Recent" means within 25 hours (allows for one missed day)

    2. should_alert_scheduler_miss(last_extraction: ExtractionLog | None, expected_hour: int) -> bool:
       - Returns True if no extraction in expected window

    3. get_scheduler_status() -> dict:
       - Returns {"status": "healthy" | "degraded" | "unhealthy", "details": str, "hours_since": float}
       - Used by health check endpoint
    </action>
  <verify>`python -c "from src.monitor.scheduler_health import check_scheduler_health; print('scheduler_health module loads')"`</verify>
  <done>check_scheduler_health function exists and returns (bool, str) tuple</done>
</task>

</tasks>

<verification>
- [ ] `python -c "from src.monitor.alerting import send_telegram_alert; print('Telegram function ready')"`
- [ ] `python -c "from src.monitor.alerting import send_email_alert; print('Email function ready')"`
- [ ] `python -c "from src.monitor.volume_alerts import check_volume_anomaly; print('Volume check ready')"`
- [ ] `python -c "from src.monitor.scheduler_health import check_scheduler_health; print('Scheduler check ready')"`
</verification>

<success_criteria>
Alerting system works:
- send_telegram_alert uses Telegram API (configurable via config.yaml)
- send_email_alert uses SMTP (configurable via config.yaml)
- check_volume_anomaly compares current vs previous counts
- check_scheduler_health verifies extraction ran at expected time
- All functions return informative messages for alerts
</success_criteria>

<output>
After completion, create `.planning/phases/02-operational-maturity/02-02-SUMMARY.md`
</output>
