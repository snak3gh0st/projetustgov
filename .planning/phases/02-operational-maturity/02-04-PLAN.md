---
phase: 02-operational-maturity
plan: "04"
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - "src/orchestrator/dry_run.py"
  - "src/api/main.py"
  - "src/cli.py"
autonomous: true
must_haves:
  truths:
    - "Dry-run mode validates extraction without writing to database"
    - "Health check endpoint returns system status"
    - "FastAPI server serves both scheduler and health endpoint"
  artifacts:
    - path: "src/orchestrator/dry_run.py"
      provides: "run_dry_run() and print_dry_run_report() functions"
    - path: "src/api/main.py"
      provides: "FastAPI app with /health endpoint"
    - path: "src/cli.py"
      provides: "CLI with --dry-run and --config options"
    - exports:
        - "run_dry_run"
        - "print_dry_run_report"
        - "app"
  key_links:
    - from: "src/orchestrator/dry_run.py"
      to: "src/parser/file_parser.py"
      via: "parse_file() for validation"
    - from: "src/orchestrator/dry_run.py"
      to: "src/transformer/validator.py"
      via: "validate_dataframe() for validation"
    - from: "src/api/main.py"
      to: "src/monitor/scheduler_health.py"
      via: "get_scheduler_status()"
    - from: "src/api/main.py"
      to: "src/loader/extraction_log.py"
      via: "get_last_extraction()"
---

<objective>
Implement dry-run mode and health check API for safe testing and external monitoring integration.

**Purpose:** Dry-run allows safe testing of parser changes. Health check enables Railway monitoring and alerting.

**Output:** Dry-run CLI command and FastAPI health endpoint.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-operational-maturity/02-RESEARCH.md
@.planning/phases/02-operational-maturity/02-01-PLAN.md

# Phase 1 already has:
- src/parser/file_parser.py - parse_file()
- src/transformer/validator.py - validate_dataframe()
- src/orchestrator/orchestrator.py - run_orchestration()

# Phase 2 requires:
- Dry-run mode (from Success Criteria #7)
- Health check endpoint (from Success Criteria #8)
</context>

<tasks>

<task type="auto">
  <name>Create dry-run module</name>
  <files>src/orchestrator/dry_run.py</files>
  <action>
    Create src/orchestrator/dry_run.py with:

    1. DryRunResult namedtuple:
       - file_path: str
       - entities_found: dict[str, int]
       - validation_errors: list[str]
       - relationships_found: list[str]
       - warnings: list[str]

    2. run_dry_run(raw_data_dir: Path = Path("data/raw")) -> DryRunResult:
       - Lists files in data/raw (or latest dated subdirectory)
       - Parses each file (without writing to DB)
       - Validates each file's columns and data
       - Detects entity types from filenames
       - Checks relationships between entities
       - Returns DryRunResult with all findings

    3. print_dry_run_report(result: DryRunResult):
       - Prints formatted report to console
       - Shows entities found with counts
       - Shows relationships detected
       - Lists validation errors if any
       - Lists warnings if any

    Does NOT write to database - purely read-only validation.
  </action>
  <verify>`python -c "from src.orchestrator.dry_run import run_dry_run, print_dry_run_report; print('dry_run module loads')"`</verify>
  <done>run_dry_run and print_dry_run_report functions exist</done>
</task>

<task type="auto">
  <name>Create FastAPI health check endpoint</name>
  <files>src/api/main.py</files>
  <action>
    Create src/api/main.py with FastAPI app:

    1. GET /health:
       - Calls get_last_extraction() from extraction_log
       - Returns JSON:
         ```json
         {
           "status": "healthy" | "degraded" | "unhealthy",
           "last_extraction": timestamp or null,
           "hours_since_last": float or null,
           "records_extracted": dict or null,
           "pipeline_version": str or null
         }
         ```

    2. GET /ready:
       - Returns 200 if all dependencies ready
       - Checks: database connection, last extraction < 25h

    3. GET /metrics:
       - Returns Prometheus-format metrics if enabled
       - Shows: extraction counts, durations, last run time

    Mount static files if needed for Railway health checks.
  </action>
  <verify>`python -c "from src.api.main import app; print('FastAPI app loads')"`</verify>
  <done>FastAPI app with /health, /ready, /metrics endpoints exists</done>
</task>

<task type="auto">
  <name>Create CLI with dry-run and config options</name>
  <files>src/cli.py</files>
  <action>
    Update src/cli.py (create if doesn't exist) with:

    ```python
    import click
    from pathlib import Path
    from src.config import get_config
    from src.orchestrator.dry_run import run_dry_run, print_dry_run_report
    from src.api.main import app

    @click.command()
    @click.option("--dry-run", is_flag=True, help="Run without writing to database")
    @click.option("--config", type=Path, default=Path("config.yaml"), help="Path to config")
    def main(dry_run: bool, config: Path):
        """PROJETUS - Transfer Gov Automation CLI."""
        if dry_run:
            result = run_dry_run()
            print_dry_run_report(result)
            return
        
        # Normal run - import and run orchestrator
        from src.orchestrator import run_pipeline
        run_pipeline(config_path=config)

    if __name__ == "__main__":
        main()
    ```

    Add uvicorn command for running API server:
    ```bash
    # Run API server
    uvicorn src.api.main:app --host 0.0.0.0 --port 8000
    ```
  </action>
  <verify>`python -c "from src.cli import main; print('CLI loads')"`</verify>
  <done>CLI with --dry-run option exists</done>
</task>

</tasks>

<verification>
- [ ] `python -c "from src.orchestrator.dry_run import run_dry_run; print('Dry-run ready')"`
- [ ] `python -c "from src.api.main import app; print('API ready')"`
- [ ] `python -c "from src.cli import main; print('CLI ready')"`
- [ ] GET /health returns valid JSON with system status
</verification>

<success_criteria>
Dry-run and health check work:
- `python -m src.cli --dry-run` validates extraction without DB writes
- GET /health returns healthy/degraded/unhealthy status
- GET /ready returns 200 when system is ready
- Railway can poll /health to verify deployment
</success_criteria>

<output>
After completion, create `.planning/phases/02-operational-maturity/02-04-SUMMARY.md`
</output>
