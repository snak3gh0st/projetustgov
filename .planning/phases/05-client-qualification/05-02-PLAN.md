---
phase: 05-client-qualification
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/dashboard/pages/qualificacao.py
  - src/dashboard/queries/proponentes.py
  - src/dashboard/streamlit_app.py
autonomous: true

must_haves:
  truths:
    - "Client can see proponents ranked by value (fewer active proposals = higher value)"
    - "Client can filter proponents by OSC vs government entity type"
    - "Client can filter by estado and search by name/CNPJ"
    - "Contact info (CNPJ, endereco, municipio) is prominently displayed"
    - "Value metrics are explained with clear labels"
    - "Client can export filtered proponent list as CSV"
  artifacts:
    - path: "src/dashboard/pages/qualificacao.py"
      provides: "Client qualification Streamlit page"
      contains: "def render_qualificacao"
    - path: "src/dashboard/queries/proponentes.py"
      provides: "Proponente query functions"
      contains: "get_proponentes"
    - path: "src/dashboard/streamlit_app.py"
      provides: "Navigation includes Qualificacao page"
      contains: "qualificacao"
  key_links:
    - from: "src/dashboard/pages/qualificacao.py"
      to: "src/dashboard/queries/proponentes.py"
      via: "Query function call"
      pattern: "get_proponentes"
    - from: "src/dashboard/streamlit_app.py"
      to: "src/dashboard/pages/qualificacao.py"
      via: "Page navigation registration"
      pattern: "qualificacao"
---

<objective>
Build the Client Qualification dashboard page in Streamlit that ranks proponents by value and enables filtering/search/export. This page is the primary interface for clients to discover and contact the most valuable proponents.

Purpose: Clients can find proponents with fewer projects (higher value) and filter by OSC/government type, state, and search terms.
Output: Qualificacao page with ranked proponent table, filters, value explanations, and CSV export.
</objective>

<execution_context>
@/Users/pauloloureiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pauloloureiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-client-qualification/05-RESEARCH.md
@.planning/phases/05-client-qualification/05-01-SUMMARY.md
@src/dashboard/streamlit_app.py
@src/dashboard/queries/entities.py
@src/dashboard/pages/propostas.py
@src/dashboard/components/filters.py
@src/dashboard/components/export.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create proponente query functions</name>
  <files>src/dashboard/queries/proponentes.py</files>
  <action>
Create `src/dashboard/queries/proponentes.py` following the pattern in `src/dashboard/queries/entities.py`:

1. `get_proponentes(limit=5000, filters=None) -> pd.DataFrame`:
   - Cached with `@st.cache_data(ttl="10m")`
   - Query proponentes table with optional filters:
     - `is_osc` (bool) - filter by OSC classification
     - `estado` (str) - filter by state
     - `search` (str) - ILIKE search on nome or cnpj
     - `min_propostas` / `max_propostas` (int) - filter by proposal count range
   - Order by `total_propostas ASC` (fewer proposals = higher value = shown first)
   - Return DataFrame with columns: cnpj, nome, natureza_juridica, is_osc, estado, municipio, cep, endereco, bairro, total_propostas, total_emendas, valor_total_emendas

2. `get_proponente_estados() -> list[str]`:
   - Cached, returns distinct estado values for filter dropdown

3. `get_proponente_stats() -> dict`:
   - Returns: total count, OSC count, government count, average propostas per proponente
  </action>
  <verify>Run `python -c "from src.dashboard.queries.proponentes import get_proponentes; print('OK')"`</verify>
  <done>Query functions exist with caching, filtering, and sorting by value (fewer proposals first).</done>
</task>

<task type="auto">
  <name>Task 2: Build qualification page and integrate into navigation</name>
  <files>src/dashboard/pages/qualificacao.py, src/dashboard/streamlit_app.py</files>
  <action>
1. Create `src/dashboard/pages/qualificacao.py`:
   - Function `render_qualificacao()` following existing page patterns (see propostas.py)
   - **Header section:**
     - Title: "Qualificacao de Proponentes"
     - Info box explaining value metrics: "Proponentes com menos propostas ativas sao mais valiosos para prospecao - indicam menor concorrencia e maior receptividade a novas parcerias. Proponentes novos (sem historico) sao os mais valiosos."
   - **KPI metrics row** (using st.columns with st.metric):
     - Total proponentes
     - Total OSCs
     - Total governo
     - Media propostas/proponente
   - **Filters sidebar** (st.sidebar):
     - "Tipo de Entidade" radio: Todos / Apenas OSCs / Apenas Governo
     - "Estado" selectbox with "Todos" option + distinct estados
     - "Buscar" text_input for name/CNPJ search
     - "Max propostas" number_input (default: no limit) - key filter for finding low-competition proponents
   - **Main table:**
     - st.dataframe with the filtered proponentes
     - Columns displayed: Rank (#), Nome, CNPJ (formatted XX.XXX.XXX/XXXX-XX), Tipo (OSC/Governo), Estado, Municipio, Propostas, Emendas, Valor Emendas
     - CNPJ formatting: display as masked `XX.XXX.XXX/XXXX-XX` using string slicing
     - Highlight rows where total_propostas == 0 (virgin proponents) with a badge/tag
     - Sort by total_propostas ASC by default (fewer = higher rank)
   - **Export section:**
     - CSV download button using existing export component pattern
     - Include all columns in export (unformatted CNPJ for data use)

2. Update `src/dashboard/streamlit_app.py`:
   - Add "Qualificacao" to the navigation tabs (add as 6th tab after Emendas)
   - Import and call `render_qualificacao()` in the new tab
   - Keep existing tab structure intact, just append the new tab

All text in Portuguese. No emojis.
  </action>
  <verify>Run `python -c "from src.dashboard.pages.qualificacao import render_qualificacao; print('OK')"` and `python -c "from src.dashboard.streamlit_app import main; print('OK')"`</verify>
  <done>Qualification page shows ranked proponents with filters, value explanations, KPIs, and CSV export. Navigation includes the new tab.</done>
</task>

</tasks>

<verification>
1. All imports pass: `python -c "from src.dashboard.pages.qualificacao import render_qualificacao; from src.dashboard.queries.proponentes import get_proponentes; print('All OK')"`
2. Streamlit app includes qualificacao in navigation
3. Proponents sorted by total_propostas ascending (fewer = more valuable = shown first)
4. OSC/Government filter works via is_osc boolean
5. CSV export available
</verification>

<success_criteria>
- Qualification page renders with KPIs, filters, ranked table, and export
- Proponents ranked by value (fewer proposals = higher rank)
- OSC vs government filtering via natureza_juridica classification
- Search by name/CNPJ works
- CSV export includes all proponent data
- All Portuguese text, no emojis
</success_criteria>

<output>
After completion, create `.planning/phases/05-client-qualification/05-02-SUMMARY.md`
</output>
