---
phase: 04-data-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/dashboard/pages/extraction_history.py
  - src/dashboard/streamlit_app.py
  - railway.json
  - Dockerfile.railway
autonomous: true

must_haves:
  truths:
    - "Extraction history shows last 30 days of pipeline runs with status (success/partial/failed)"
    - "Dashboard is deployable on Railway alongside the existing API service"
    - "Pipeline run status visible with row counts"
  artifacts:
    - path: "src/dashboard/pages/extraction_history.py"
      provides: "Extraction history page with 30-day run history"
      min_lines: 40
    - path: "railway.json"
      provides: "Updated Railway config supporting dashboard service"
    - path: "Dockerfile.railway"
      provides: "Updated Dockerfile with streamlit dependency"
  key_links:
    - from: "src/dashboard/pages/extraction_history.py"
      to: "src/dashboard/queries/history.py"
      via: "Import get_extraction_history"
      pattern: "from.*queries.*history.*import|get_extraction_history"
    - from: "railway.json"
      to: "src/dashboard/streamlit_app.py"
      via: "Streamlit start command for Railway deployment"
      pattern: "streamlit.*run|dashboard"
---

<objective>
Build the extraction history page showing pipeline run status over 30 days, and configure Railway deployment so the Streamlit dashboard can run alongside the existing FastAPI service.

Purpose: Delivers operational visibility into pipeline health (success/partial/failed runs with row counts and timing), and ensures the dashboard is deployable to production on Railway.

Output: Extraction history page wired into navigation, updated Railway deployment config for dual-service setup (FastAPI + Streamlit).
</objective>

<execution_context>
@/Users/pauloloureiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pauloloureiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-data-dashboard/04-CONTEXT.md
@.planning/phases/04-data-dashboard/04-RESEARCH.md
@.planning/phases/04-data-dashboard/04-01-SUMMARY.md
@src/loader/db_models.py
@railway.json
@Dockerfile.railway
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extraction history page</name>
  <files>
    src/dashboard/pages/extraction_history.py
    src/dashboard/streamlit_app.py
  </files>
  <action>
    1. Create `src/dashboard/pages/extraction_history.py`:
       - Page title: "Extraction History"
       - Time range selector: default to 7 days (per user decision), with options for 7, 14, 30 days. Use the shared `render_time_range_selector()` component or st.segmented_control.
       - Main content: Display extraction_logs data from `get_extraction_history(days=selected_range)`.
       - Summary section at top: Total runs in period, success count, partial count, failed count. Use st.metric cards in columns.
       - History table: st.dataframe showing all runs with columns: run_date (formatted), status (with color-coded badges using st.dataframe column_config — green for success, yellow for partial, red for failed), total_records, records_inserted, records_updated, duration_seconds (formatted as "Xs" or "Xm Ys").
       - Sort by run_date descending (most recent first).
       - If error_message exists for a run, show it in an expandable row or via row selection detail.
       - CSV export for extraction history.

    2. Update `src/dashboard/streamlit_app.py`:
       - Add the extraction history page to st.navigation. The sidebar should now show: Home, Propostas, Programas, Apoiadores, Emendas, Extraction History (or "Pipeline History").
       - Note: if Plan 02 hasn't run yet, keep placeholders for entity pages — this plan is independent of Plan 02.

    Important: Handle the case where extraction_logs table is empty (show "No extraction history available" message). Format dates in Brazilian format (DD/MM/YYYY HH:MM) for display. Status values from ExtractionLog are: 'success', 'partial', 'failed'.
  </action>
  <verify>
    Run `uv run python -c "from src.dashboard.pages.extraction_history import *; print('Extraction history page imports OK')"`.
  </verify>
  <done>Extraction history page shows pipeline runs for configurable time range (default 7 days, up to 30). Runs display with status color coding, row counts, and duration. Summary metrics at top. CSV export available.</done>
</task>

<task type="auto">
  <name>Task 2: Configure Railway deployment for Streamlit dashboard</name>
  <files>
    railway.json
    Dockerfile.railway
  </files>
  <action>
    1. The existing railway.json runs FastAPI on PORT. For Railway, the recommended approach for a second service is to create a separate service config. However, since the project uses a single railway.json, the simplest approach is:

       Option A (recommended): Add a note/script that the dashboard can be started as a separate Railway service pointing to the same repo but with a different start command: `uv run streamlit run src/dashboard/streamlit_app.py --server.port $PORT --server.headless true --server.address 0.0.0.0`.

       For now, update railway.json to keep the existing FastAPI config (do not break it). Create a `railway.dashboard.json` file that can be used for a separate Railway service deployment:
       ```json
       {
         "$schema": "https://railway.app/railway.schema.json",
         "build": {
           "builder": "DOCKERFILE",
           "dockerfilePath": "Dockerfile.railway"
         },
         "deploy": {
           "startCommand": "sh -c 'uv run streamlit run src/dashboard/streamlit_app.py --server.port ${PORT:-8501} --server.headless true --server.address 0.0.0.0'",
           "healthcheckPath": "/_stcore/health",
           "healthcheckTimeout": 100,
           "restartPolicyType": "ON_FAILURE",
           "restartPolicyMaxRetries": 3
         }
       }
       ```

    2. Update `Dockerfile.railway`:
       - Ensure streamlit is included in dependencies (it should be after `uv sync` picks up pyproject.toml changes from Plan 01).
       - Verify the Dockerfile installs all dependencies correctly. The existing Dockerfile likely uses `uv sync` which will automatically include streamlit after it was added to pyproject.toml.
       - If the Dockerfile uses a multi-stage build or copies specific files, ensure `src/dashboard/` is included.
       - EXPOSE both 8000 (FastAPI) and 8501 (Streamlit) or just use PORT variable.
       - Do NOT change the existing FastAPI start command in railway.json — Railway will use separate services.

    Important: Do NOT break the existing FastAPI deployment. The dashboard is a SEPARATE service on Railway that shares the same codebase and database. Both services read DATABASE_URL from environment variables.
  </action>
  <verify>
    Run `cd /Users/pauloloureiro/Desktop/Work/Sigma/Projects/Projetus && uv run streamlit run src/dashboard/streamlit_app.py --server.headless true --server.port 8501 &` and verify it starts. Then check the railway.dashboard.json file exists and is valid JSON with `python -c "import json; json.load(open('railway.dashboard.json'))"`. Kill the streamlit process after verification.
  </verify>
  <done>Railway deployment config exists for dashboard as separate service. Existing FastAPI deployment in railway.json is untouched. Dockerfile supports both services. Dashboard can be started locally with `uv run streamlit run src/dashboard/streamlit_app.py`.</done>
</task>

</tasks>

<verification>
1. Extraction history page imports and renders without error
2. Navigation includes all 6 pages (Home + 4 entities + Extraction History)
3. railway.dashboard.json is valid JSON with correct Streamlit start command
4. Existing railway.json is unchanged (FastAPI still works)
5. Streamlit app starts locally on port 8501
</verification>

<success_criteria>
- Extraction history page shows pipeline runs with color-coded status
- Time range selector allows 7/14/30 day views (default 7)
- Summary metrics show total/success/partial/failed counts
- Railway dashboard config is ready for separate service deployment
- Existing FastAPI deployment is unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-dashboard/04-03-SUMMARY.md`
</output>
