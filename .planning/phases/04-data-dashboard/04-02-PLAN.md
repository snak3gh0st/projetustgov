---
phase: 04-data-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/dashboard/pages/propostas.py
  - src/dashboard/pages/programas.py
  - src/dashboard/pages/apoiadores.py
  - src/dashboard/pages/emendas.py
  - src/dashboard/streamlit_app.py
autonomous: true

must_haves:
  truths:
    - "Data tables are browsable with search, sort, and filter capabilities"
    - "Propostas can be explored with related programas, apoiadores, and emendas"
    - "Selecting a proposta auto-filters other sidebar tabs to show only related entities"
    - "CSV export button works on each data table for the current filtered view"
    - "Portuguese characters render correctly throughout the dashboard"
  artifacts:
    - path: "src/dashboard/pages/propostas.py"
      provides: "Propostas detail page with cross-filtering and drill-down"
      min_lines: 60
    - path: "src/dashboard/pages/programas.py"
      provides: "Programas detail page"
      min_lines: 40
    - path: "src/dashboard/pages/apoiadores.py"
      provides: "Apoiadores detail page"
      min_lines: 40
    - path: "src/dashboard/pages/emendas.py"
      provides: "Emendas detail page"
      min_lines: 40
  key_links:
    - from: "src/dashboard/pages/propostas.py"
      to: "st.session_state.selected_proposta_id"
      via: "on_select callback on st.dataframe"
      pattern: "session_state.*selected_proposta|on_select"
    - from: "src/dashboard/pages/programas.py"
      to: "st.session_state.selected_proposta_id"
      via: "Reads selected_proposta_id to filter related programas"
      pattern: "session_state.*selected_proposta|active_entity_filter"
    - from: "src/dashboard/pages/propostas.py"
      to: "src/dashboard/queries/entities.py"
      via: "Import get_propostas and get_related_entities"
      pattern: "from.*queries.*entities.*import|get_propostas|get_related_entities"
---

<objective>
Build all 4 entity detail pages (Propostas, Programas, Apoiadores, Emendas) with interactive data tables, search/sort/filter, CSV export, and cross-filtering. Selecting a proposta on the Propostas page stores its ID in session_state, and other entity pages auto-filter to show only related records.

Purpose: Delivers the core data exploration capability — users can browse all Transfer Gov data without writing SQL queries, drill down into propostas to see related entities, and export filtered views as CSV.

Output: 4 fully functional entity pages wired into the Streamlit navigation, with cross-filtering via session_state.
</objective>

<execution_context>
@/Users/pauloloureiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pauloloureiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-data-dashboard/04-CONTEXT.md
@.planning/phases/04-data-dashboard/04-RESEARCH.md
@.planning/phases/04-data-dashboard/04-01-SUMMARY.md
@src/loader/db_models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Propostas page with cross-filtering and drill-down</name>
  <files>
    src/dashboard/pages/propostas.py
    src/dashboard/streamlit_app.py
  </files>
  <action>
    1. Create `src/dashboard/pages/propostas.py`:
       - Page title: "Propostas"
       - Top section: render filter widgets using shared components:
         - Text search (searches across titulo, proponente, municipio)
         - Estado selectbox (populated from distinct values in data)
         - Situacao multiselect (populated from distinct values)
         - Date range filter on data_publicacao
       - Main section: `st.dataframe` showing propostas with built-in sort. Default visible columns: transfer_gov_id, titulo, valor_global, situacao, estado, municipio, proponente, data_publicacao. Additional columns (valor_repasse, valor_contrapartida, data_inicio_vigencia, data_fim_vigencia, programa_id) available but not shown by default — use column_config to set these as initially hidden or use an expander.
       - Row selection: Use `st.dataframe` with `on_select="rerun"` and `selection_mode="single-row"`. When a row is selected, store its `transfer_gov_id` in `st.session_state.selected_proposta_id`.
       - Below the main table, if a proposta is selected, show a drill-down section using st.expander or st.tabs showing related programas, apoiadores, and emendas (from `get_related_entities()`).
       - CSV export button for the current filtered view using `render_csv_export()`.
       - Add a "Clear selection" button that resets `st.session_state.selected_proposta_id` to None.

    2. Update `src/dashboard/streamlit_app.py`:
       - Replace placeholder pages with actual imports from `src.dashboard.pages.propostas`, etc.
       - Wire propostas.py as the Propostas page in st.navigation.
       - Ensure session_state initialization still happens before navigation.

    Important: When reading cached DataFrames, always `.copy()` before filtering or displaying. Handle empty DataFrames gracefully (show "No data available" message). Text search should be case-insensitive and work with Portuguese characters (use `.str.contains(search, case=False, na=False)`).
  </action>
  <verify>
    Run `uv run python -c "from src.dashboard.pages.propostas import *; print('Propostas page imports OK')"` to verify the page module loads.
  </verify>
  <done>Propostas page displays interactive data table with search, sort, filter by estado/situacao/date. Row selection stores proposta ID in session_state. Drill-down shows related entities. CSV export works.</done>
</task>

<task type="auto">
  <name>Task 2: Create Programas, Apoiadores, Emendas pages with cross-filter awareness</name>
  <files>
    src/dashboard/pages/programas.py
    src/dashboard/pages/apoiadores.py
    src/dashboard/pages/emendas.py
    src/dashboard/streamlit_app.py
  </files>
  <action>
    1. Create `src/dashboard/pages/programas.py`:
       - Page title: "Programas"
       - If `st.session_state.selected_proposta_id` is set, show an info banner: "Filtering by Proposta: {id}" with a "Show all" button to clear the filter.
       - When filtered: query only the programa linked to the selected proposta (via proposta.programa_id).
       - When unfiltered: show all programas with search/filter.
       - Default visible columns: transfer_gov_id, nome, orgao_superior, modalidade, acao_orcamentaria. Additional: orgao_vinculado, natureza_juridica (initially hidden).
       - Text search across nome, orgao_superior.
       - CSV export button.

    2. Create `src/dashboard/pages/apoiadores.py`:
       - Page title: "Apoiadores"
       - Cross-filter awareness: if `st.session_state.selected_proposta_id` is set, query only apoiadores linked via proposta_apoiadores junction table. Show info banner with "Show all" button.
       - When unfiltered: show all apoiadores with search/filter.
       - Default visible columns: transfer_gov_id, nome, tipo, orgao.
       - Text search across nome, orgao.
       - Filter by tipo (selectbox from distinct values).
       - CSV export button.

    3. Create `src/dashboard/pages/emendas.py`:
       - Page title: "Emendas"
       - Cross-filter awareness: if `st.session_state.selected_proposta_id` is set, query only emendas linked via proposta_emendas junction table. Show info banner with "Show all" button.
       - When unfiltered: show all emendas with search/filter.
       - Default visible columns: transfer_gov_id, numero, autor, valor, tipo, ano.
       - Text search across numero, autor.
       - Filter by tipo and ano (selectbox/multiselect).
       - CSV export button.

    4. Update `src/dashboard/streamlit_app.py`:
       - Replace any remaining placeholder pages with actual imports for programas, apoiadores, emendas.
       - All 5 pages now wired into st.navigation.

    Pattern for all 3 pages: Each follows the same structure — check cross-filter state, render filters, query data (filtered or all), display st.dataframe with sort, render CSV export. Keep the pattern consistent across all pages.

    Important: The "Show all" button on each page must set `st.session_state.selected_proposta_id = None` and trigger `st.rerun()`. All pages must handle empty results gracefully. All text displayed in the dashboard uses Portuguese labels where appropriate (matching source data column names).
  </action>
  <verify>
    Run `uv run python -c "from src.dashboard.pages.programas import *; from src.dashboard.pages.apoiadores import *; from src.dashboard.pages.emendas import *; print('All entity pages import OK')"` to verify all page modules load.
  </verify>
  <done>All 4 entity pages render with interactive data tables. Cross-filtering works: selecting a proposta on the Propostas page causes Programas/Apoiadores/Emendas pages to auto-filter to related records with "Show all" option. CSV export available on each page. Search and column filters work on each page.</done>
</task>

</tasks>

<verification>
1. All 4 entity page modules import without error
2. streamlit_app.py has all 5 pages wired into st.navigation
3. Cross-filtering state flows via st.session_state.selected_proposta_id
4. Each page has CSV export via render_csv_export component
5. Each page has text search and column-specific filters
</verification>

<success_criteria>
- Propostas page shows all propostas with search, sort, filter by estado/situacao/date
- Selecting a proposta row stores its ID and triggers cross-filtering on other pages
- Programas, Apoiadores, Emendas pages show cross-filter banner when proposta is selected
- "Show all" button clears cross-filter and shows full dataset
- CSV export on each page exports current filtered view with correct UTF-8 encoding
- Empty state handled gracefully on all pages
</success_criteria>

<output>
After completion, create `.planning/phases/04-data-dashboard/04-02-SUMMARY.md`
</output>
